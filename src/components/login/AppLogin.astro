---
const email = Astro.cookies.get('email') ?.value ?? '';
const remenberMe = !! email;
---


<section class="login-container">
  <form class="login-form">
    <h2>Iniciar sesión</h2>

    <label for="email">Email</label>
    <input type="email" value={email} id="email" name="email" required />

    <label for="password">Contraseña</label>
    <input type="password" id="password" name="password" required />

    <div class="login-extras">
      <label class="remember">
        <input type="checkbox" checked={remenberMe} name="rememberMe" /> Recordarme
      </label>
      <a href="/forgot" class="forgot">Olvidé mi contraseña</a>
    </div>

    <button id="btn-submit" type="submit">Ingresar</button>

    <p class="alt-link"> ¿No tenés cuenta? <a href="/register">Registrate</a> </p>

     <button type="button" id="btn-google" class="btn btn-google" >
            log in with google
      </button>
  </form>
</section>

<style>
.login-container {
  display: grid;
  place-items: center;
  min-height: 100vh;
  background: #f8f8f8;
}

.login-form {
  display: grid;
  gap: 1rem;
  background: white;
  padding: 2rem;
  border-radius: 0.5rem;
  width: 100%;
  max-width: 400px;
  box-shadow: 0 0 10px rgba(0,0,0,0.05);
}

.login-form h2 {
  margin: 0;
  text-align: center;
  color: #333;
}

.login-form label {
  font-weight: 500;
}

.login-form input[type="email"],
.login-form input[type="password"] {
  padding: 0.5rem;
  border: 1px solid #ccc;
  border-radius: 0.25rem;
  width: 100%;
}

.login-extras {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.875rem;
}

.login-extras .forgot {
  color: #0077cc;
  text-decoration: none;
}

.login-form button {
  padding: 0.75rem;
  background: #0077cc;
  color: white;
  border: none;
  border-radius: 0.25rem;
  cursor: pointer;
}

.alt-link {
  text-align: center;
  font-size: 0.875rem;
}

.alt-link a {
  color: #0077cc;
  text-decoration: none;
}
</style>


<script>
  import Swal from 'sweetalert2';
  import { signIn } from 'auth-astro/client';

  const form = document.querySelector('form') as HTMLFormElement;
  const btnSubmit = document.querySelector('#btn-submit') as HTMLButtonElement;
  const bntGoogle = document.querySelector('#btn-google') as HTMLButtonElement;
 
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    btnSubmit.setAttribute('disabled', 'disabled');

    const formData = new FormData(form);

    try {
      const resp = await signIn('credentials', {
        email: formData.get('email') as string,
        password: formData.get('password') as string,
        redirect: false, 
      });
      
      if ((resp as any)?.error) {
        Swal.fire({
          icon: 'error',
          title: 'Login error',
          text: 'Incorrect username or password.',
        });
      } else {
        //Si el login es exitoso, redirige a una página 
        window.location.replace('/redirect-by-role');
      }
    } catch (error) {
      console.error(error);
      Swal.fire({
        icon: 'error',
        title: 'Error inesperado',
        text: 'Ocurrió un problema de conexión. Inténtalo de nuevo.',
      });
    } finally {
      btnSubmit.removeAttribute('disabled');
    }
  });

  bntGoogle.addEventListener('click', async () => {
    bntGoogle.setAttribute('disabled', 'disabled');
    await signIn('google');
    bntGoogle.removeAttribute('disabled');
  });
</script>